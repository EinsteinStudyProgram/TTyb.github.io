<!DOCTYPE html>
<html>

<head>

    <link rel="shortcut icon" href="/static/jpg/myjpg.jpg"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <!-- Stylesheets -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/static/css/font-awesome.min.css" rel="stylesheet"/>
	<link href="/static/css/styles.css" rel="stylesheet"/>

    <script type="text/javascript" src="/static/js/jquery.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/modernizr.js"></script>
    <script type="text/javascript" src="/static/js/prefixfree.min.js"></script>
    <title>百哥么么哒|个人网站</title>

</head>


<body>
    <div class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <a class="navbar-brand brand" href="/">TTyb|个人网站</a>
        <div style="font-size: 6px;font-family: serif;text-decoration: none;">
            <ul class="nav navbar-nav">
                <li><a class="navbar-brand" href="/">首页</a></li>
                <li><a class="navbar-brand" href="/topic">文章</a></li>
                <li><a class="navbar-brand" href="/category">分类</a></li>
                <li><a class="navbar-brand" href="/log/log">日志</a></li>
                <li><a class="navbar-brand" href="/guestbook">留言</a></li>
            </ul>
        </div>

        <div class="pull-right">
            <div style="font-size: 4px;font-family: serif;">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="/contact" class="navbar-brand">联系方式</a>
                    </li>
                    <li>
                        <a data-toggle="dropdown" class="dropdown-toggle navbar-brand" href="#">友情链接<strong
                                class="caret"></strong></a>
                        <ul class="dropdown-menu container-fluid" style="border-radius: 6px 6px 6px 6px;">
                            <li><a href="http://www.cnblogs.com/TTyb">TTyb博客园</a></li>
                            <li><a href="http://www.cnblogs.com/nima">一只尼玛博客园</a></li>
                            <li><a href="https://github.com/TTyb">TTybGithub</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

    </div>
</div>

        <div class="container">
    <div class="page-header">
        <hr>
        <h3>python3抓取异步百度瀑布流动态图片（二）get、json下载代码讲解</a></h3>
        <small>
            分类：python
        </small>
        <h6 class="text-muted">作者:TTyb&nbsp;&nbsp;文章发表于 2016-08-28</h6>
        <br/>
        <p class="content text-overflow">
            <p>制作解析网址的get;</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def gethtml(url,postdata):

    header = {'User-Agent':
                'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0',
                'Referer':
                'http://image.baidu.com',
                'Host': 'image.baidu.com',
                'Accept': 'text/plain, */*; q=0.01',
                'Accept-Encoding':'gzip, deflate',
                'Accept-Language':'zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3',
                'Connection':'keep-alive'}

    # 解析网页
    html_bytes = requests.get(url, headers=header,params = postdata)

    return html_bytes
</code></pre>
</div>

<p>头部的构造请参考上一篇博文</p>

<p>分析网址：</p>

<p><code class="highlighter-rouge">http://image.baidu.com/search/acjson?tn=resultjson_com&amp;ipn=rj&amp;ct=201326592&amp;is=&amp;fp=result&amp;queryWord=gif&amp;cl=2&amp;lm=-1&amp;ie=utf-8&amp;oe=utf-8&amp;adpicid=&amp;st=-1&amp;z=&amp;ic=0&amp;word=gif&amp;s=&amp;se=&amp;tab=&amp;width=&amp;height=&amp;face=0&amp;istype=2&amp;qc=&amp;nc=1&amp;fr=&amp;pn=30&amp;rn=30&amp;gsm=1e&amp;1472364207674=</code></p>

<p>分解为：</p>

<p><code class="highlighter-rouge">url = 'http://image.baidu.com/search/acjson?' + postdata + lasturl</code></p>

<p>lasturl为时间戳，精确到后三位小数的时间戳，构造这个时间戳，后三位小数我就随机生成一个三位数了：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import time
import random
timerandom = random.randint(100,999)
nowtime = int(time.time())
lasturl = str(nowtime) + str(timerandom) + '='
</code></pre>
</div>

<p>最后制作postdata：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># 构造post
postdata = {
    'tn':'resultjson_com',
    'ipn':'rj',
    'ct':201326592,
    'is':'',
    'fp':'result',
    'queryWord': keyword,
    'cl': 2,
    'lm': -1,
    'ie': 'utf-8',
    'oe': 'utf-8',
    'adpicid': '',
    'st': -1,
    'z':'',
    'ic': 0,
    'word': keyword,
    's': '',
    'se': '',
    'tab': '',
    'width': '',
    'height': '',
    'face': 0,
    'istype': 2,
    'qc': '',
    'nc': 1,
    'fr': '',
    'pn': pn,
    'rn': 30,
    'gsm': '1e'
}
</code></pre>
</div>

<p>其中页数pn和搜索关键字keywork为：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># 搜索的关键字
# keywork = input('请输入你要查找的关键字')
keyword = 'gif'

# 页数
# pn = int(input('你要抓取多少页：'))
pn = 30
</code></pre>
</div>

<p>将得到的信息保存在本地，当所有都保存下来了再去下载图片：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># 解析网址
contents = gethtml(url,postdata)

# 将文件以json的格式保存在json文件夹
file = open('../json/' + str(pn) + '.json', 'wb')
file.write(contents.content)
file.close()
</code></pre>
</div>

<p>读取文件夹里面的所有文件：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># 找出文件夹下所有xml后缀的文件
def listfiles(rootdir, prefix='.xml'):
    file = []
    for parent, dirnames, filenames in os.walk(rootdir):
        if parent == rootdir:
            for filename in filenames:
                if filename.endswith(prefix):
                    file.append(rootdir + '/' + filename)
            return file
        else:
            pass
</code></pre>
</div>

<p>遍历json文件夹，读取里面的东西：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># 找到json文件夹下的所有文件名字
files = listfiles('../json/', '.json')
for filename in files:
    print(filename)
    # 读取json得到图片网址
    doc = open(filename, 'rb')
    # ('UTF-8')('unicode_escape')('gbk','ignore')
    doccontent = doc.read().decode('utf-8', 'ignore')
    product = doccontent.replace(' ', '').replace('\n', '')
    product = json.loads(product)
</code></pre>
</div>

<p>查询字典data：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># 得到字典data
onefile = product['data']
</code></pre>
</div>

<p>将字典里面的图片网址和图片名称放到数组里面：</p>

<p><img src="http://images2015.cnblogs.com/blog/996148/201608/996148-20160828165924367-733078421.png" alt="" /></p>

<p>制作一个解析头来解析图片下载：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def getimg(url):

    # 制作一个专家
    opener = urllib.request.build_opener()

    # 打开专家头部
    opener.addheaders = [('User-Agent',
                          'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0'),
                         ('Referer',
                          'http://image.baidu.com'),
                         ('Host', 'image.baidu.com')]
    # 分配专家
    urllib.request.install_opener(opener)

    # 解析img
    html_img = urllib.request.urlopen(url)

    return html_img
</code></pre>
</div>

<p>最后将图片下载到本地的gif文件夹：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>for item in onefile:
    try:
        pic = getimg(item['thumbURL'])
        # 保存地址和名称
        filenamep = '../gif/' + validateTitle(item['fromPageTitleEnc'] + '.gif')
        # 保存为gif
        filess = open(filenamep, 'wb')
        filess.write(pic.read())
        filess.close()

        # 每一次下载都暂停1-3秒
        loadimg = random.randint(1, 3)
        print('图片' + filenamep + '下载完成')
        print('暂停' + loadimg + '秒')
        time.sleep(loadimg)

    except Exception as err:
        print(err)
        print('暂停' + loadimg + '秒')
        time.sleep(loadimg)
        pass
</code></pre>
</div>

<p>得到效果如下：</p>

<p><img src="http://images2015.cnblogs.com/blog/996148/201608/996148-20160828172535915-551271077.png" alt="" /></p>

<p>本文只是编程，处理这种网址最重要的是思想，思想我写在上一篇博文</p>

<p>思想有了，程序是很简单的问题而已。</p>

        </p>
    </div>
    <!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="http://localhost:4000/python/python3%E6%8A%93%E5%8F%96%E5%BC%82%E6%AD%A5%E7%99%BE%E5%BA%A6%E7%80%91%E5%B8%83%E6%B5%81%E5%8A%A8%E6%80%81%E5%9B%BE%E7%89%87-%E4%BA%8C-get-json%E4%B8%8B%E8%BD%BD%E4%BB%A3%E7%A0%81%E8%AE%B2%E8%A7%A3.html"
     data-title="python3抓取异步百度瀑布流动态图片（二）get、json下载代码讲解" data-url="http://localhost:4000/python/python3%E6%8A%93%E5%8F%96%E5%BC%82%E6%AD%A5%E7%99%BE%E5%BA%A6%E7%80%91%E5%B8%83%E6%B5%81%E5%8A%A8%E6%80%81%E5%9B%BE%E7%89%87-%E4%BA%8C-get-json%E4%B8%8B%E8%BD%BD%E4%BB%A3%E7%A0%81%E8%AE%B2%E8%A7%A3.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"ttyb"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();

</script>
<!-- 多说公共JS代码 end -->

</div>


    
<a class="gototop" title="返回顶部" target="_self" href="#"></a>
<div class="container">
    <div id="footer" class="text-muted">
        <div style="font-family: 'Lato', sans-serif;">
            <div class="foo">
                <span class="letter" data-letter="T">T</span>
                <span class="letter" data-letter="T">T</span>
                <span class="letter" data-letter="y">y</span>
                <span class="letter" data-letter="b">b</span>
            </div>
        </div>
        <h3 style="font-size: 1.2em;font-family: KaiTi;">无聊就想打码 打码使我快乐</h3>
        <div style="font-size: 1.2em;font-family: KaiTi;">
            不用多久<br/>
            我就会升职加薪<br/>
            当上总经理<br/>
            出任CEO<br/>
            迎娶白富美<br/>
            走上人生巅峰
        </div>
    </div>
</div>
<footer id="footer">
    <ul class="icons">
        <li><a href="/contact" class="icon fa-qq"><span class="label">QQ</span></a></li>
        <li><a href="https://github.com/TTyb" class="icon fa-github"><span class="label">Github</span></a></li>
        <li><a href="/" class="icon fa-home"><span class="label">首页</span></a></li>
        <li><a href="http://www.cnblogs.com/TTyb/" class="icon fa-heart"><span class="label">博客园</span></a></li>
        <li><a href="/cloud" class="icon fa-cloud"><span class="label">云世界</span></a></li>
        <li><a href="/404" class="icon fa-map-signs"><span class="label">404</span></a></li>
    </ul>
    <p class="copyright">Copyright &copy; TTyb All rights reserved.</p>
</footer>

<script type="text/javascript" src="/static/js/jquery.gototop.min.js"></script>
<script type="text/javascript">
    $(function(){
            // $(".gototop").gototop();
            $(".gototop").gototop({
                position : 0,
                duration : 1250,
                visibleAt : 300,
                classname : "isvisible"
            });
        });
</script>


</body>
</html>
