---
layout: post
categories: [crawler]
title: 分布式抓取
date: 2117-07-22
author: TTyb
desc: "14.分布式抓取"
showdate: 2017-07-22
---

前面的文章都是基于在单机操作，正常情况下，一台机器无论配置多么高，线程开得再多，也总会有一个上限，或者说成本过于巨大。因此，本文将提及分布式的爬虫，让爬虫的效率提高得更快。

构建分布式爬虫首先需要有多台机器，作者利用 `VMware` 安装了 `2` 台虚拟机，安装的教程请看 [VMwareWorkstation下安装Linux](http://www.tybai.com/linux/VMwareWorkstation%E4%B8%8B%E5%AE%89%E8%A3%85Linux.html)。安装的 `2` 台机器为 `CentOS6.6` ，命名为 `device1` 、`device2` ，`master` 为 `device1` ， 初始密码为 `1111` 。

安装好了后，用 `Xshell5` 打开虚拟机的命令行，打开方式如下：

>1. 安装 `Xshell5` ，可以在本网站首页 中的网盘中下载安装
>2. 在虚拟机中右键打开控制台，输入 `ifconfig` 得到机器的 `ip` 地址
>3. 在 `Xshell5` 中新建连接，名称为 `device1` 、 `device2` ，主机为 `ip` 地址，使用 **用户身份验证登陆** ，用户名是 `root` ， 密码是 `1111`

首先需要给虚拟机安装 `redis` 集群，安装集群需要 `ruby` 环境，每台机器执行如下命令：

```
yum -y  install zlib ruby rubygems
```

这里我用两台服务器，`6` 个节点，互为主从，即 `3` 个主节点 `3` 个从节点 ，我的两台机器的 `ip` 地址为 `192.168.230.218` 和 `192.168.230.130` ，分别给两台机器安装 `redis` ，在 `/usr/local/` 目录下操作，两台机器都进行如下操作：

```
cd /usr/local/
wget http://download.redis.io/releases/redis-3.2.0.tar.gz
tar -zxvf redis-3.2.0.tar.gz
mkdir redis
cd redis-3.2.0
make install PREFIX=/usr/local/redis
```

将集群工具复制到 `/usr/local/redis/bin` 下，创建目录和配置文件：

```
cp /usr/local/redis-3.2.0/src/redis-trib.rb /usr/local/redis/bin/
mkdir -p /usr/local/redis/{conf,data,logs}
cd /usr/local/redis
cp /usr/local/redis-3.2.0/redis.conf ./conf/redis-6380.conf
```

更改配置文件 `redis-6380.conf` 为：

```
# 基本配置
daemonize  yes
pidfile /usr/local/redis/data/redis-6380.pid
port 6380
bind 192.168.230.218
unixsocket /usr/local/redis/data/redis-6380.sock
unixsocketperm 700
timeout 300
loglevel verbose
logfile /usr/local/redis/logs/redis-6380.log
databases 16
dbfilename dump-6380.rdb
dir /usr/local/redis/data/ 

# aof持久化
appendonly yes
appendfilename appendonly-6380.aof
appendfsync everysec
no-appendfsync-on-rewrite yes
auto-aof-rewrite-percentage 80-100
auto-aof-rewrite-min-size 64mb
lua-time-limit 5000

# 集群配置
cluster-enabled yes
cluster-config-file /usr/local/redis/data/nodes-6380.conf 
cluster-node-timeout 5000
```

启动 `redis` ：

```
cd /usr/local/redis/
./bin/redis-server ./conf/redis-6380.conf
./bin/redis-server ./conf/redis-6381.conf
./bin/redis-server ./conf/redis-6382.conf
```

开始启动集群，注意两台机器的 `redis` 都要启动，都启动后执行如下命令：

```
cd /usr.local/
gem install redis
./bin/redis-trib.rb create --replicas 1 192.168.230.218:6380 192.168.230.218:6381 192.168.230.218:6382 192.168.230.130:6383 192.168.230.130:6384 192.168.230.130:6385
```

如果出现：

```
Could not connect to Redis at 192.168.230.130:6380: No route to host
```

则说明 `192.168.230.130` 的防火墙或者端口没开，简单一点的操作在 `192.168.230.130` 中执行：

```
iptables -A INPUT -p TCP --dport 6380 -j REJECT
iptables -A INPUT -p TCP --dport 6381 -j REJECT
iptables -A INPUT -p TCP --dport 6382 -j REJECT
sudo iptables -F
```

如果创建 `Node` 失败，即报出错误：

```
[ERR] Node 192.168.230.218:6380 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0.
```

则依次对每台机器每个端口都执行如下命令：

```
/usr/local/redis/bin/redis-cli -h 192.168.230.130 -p 6383
flushdb
/usr/local/redis/bin/redis-cli -h 192.168.230.130 -p 6384
flushdb
/usr/local/redis/bin/redis-cli -h 192.168.230.130 -p 6385
flushdb
```

并且将 `data` 里面的文件删除：

```
cd /usr/local/redis/data/
rm -rf ./*
```

最后重启全部的节点。其实启动和关闭可以写两个 `shell` 脚本执行，启动脚本 `start.sh`：

```
cd /usr/local/redis/
./bin/redis-server ./conf/redis-6380.conf
./bin/redis-server ./conf/redis-6381.conf
./bin/redis-server ./conf/redis-6382.conf
```

关闭脚本 `end.sh` ：

```
/usr/local/redis/bin/redis-cli -h 192.168.230.130 -p 6383 shutdown
/usr/local/redis/bin/redis-cli -h 192.168.230.130 -p 6384 shutdown
/usr/local/redis/bin/redis-cli -h 192.168.230.130 -p 6385 shutdown
```

集群测试是否安装成功，两台机器都启动 `redis` 后，在 `device1` 中执行：

```
/usr/local/redis/bin/redis-cli -h 192.168.230.130 -p 6383
```

出现如下对话框：

<p style="text-align:center"><img src="/img/crawler14/result1.jpg"/></p>

则说明两台机器已经可以相互通讯了，防火墙已经关闭。

如果在执行了：

```
./bin/redis-trib.rb create --replicas 1 192.168.230.218:6380 192.168.230.218:6381 192.168.230.218:6382 192.168.230.130:6383 192.168.230.130:6384 192.168.230.130:6385
```

屏幕出现如下字样：

<p style="text-align:center"><img src="/img/crawler14/result2.jpg"/></p>

则说明 `redis` 集群连接成功，下面试一下通讯。在 `192.168.230.218` 输入以下命令进入集群模式：

```
/usr/local/redis/bin/redis-cli -c -h 192.168.230.130 -p 6385
192.168.230.130:6385> set ttyb baige
-> Redirected to slot [12905] located at 192.168.230.130:6384
OK
```

在 `192.168.230.130` 查询是否收到了命令：

```
/usr/local/redis/bin/redis-cli -c -h 192.168.230.218 -p 6382
192.168.230.218:6382> get ttyb
-> Redirected to slot [12905] located at 192.168.230.130:6384
"baige"
```

`redis` 集群搭建完毕！！！

现在需要在 `Linux` 系统里面安装相对应的 `python` 版本到系统里面，安装的教程请看 [Linux下python2和python3共存](http://www.tybai.com/linux/Linux%E4%B8%8Bpython2%E5%92%8Cpython3%E5%85%B1%E5%AD%98.html)。

安装完 `python` 后，可以先在本地写好脚本，再上传到虚拟机里面，推荐使用 `Xshell5` 和 `Xftp5` 。在本机先下载一个 `redis` 软件，这个可以在我的网盘里面弄找到[百度网盘](http://pan.baidu.com/s/1i51eBid#list/path=%2F)，

<p style="text-align:center"><img src="/img/crawler14/result1.jpg"/></p>

# 源码

<a href="/code/crawler13/crawler13.py" target="_blank">crawler13.py</a>
